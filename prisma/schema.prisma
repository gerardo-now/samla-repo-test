// SAMLA - Multi-tenant Conversation AI Platform
// Prisma Schema - All models including billing

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================================================
// MULTI-TENANCY
// ============================================================================

model Workspace {
  id                  String   @id @default(cuid())
  name                String
  slug                String   @unique
  billingRegion       String   @default("NA")
  billingCountry      String?
  timezone            String   @default("America/Mexico_City")
  language            String   @default("es") // System UI language: es, en, pt
  liveModeEnabled     Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relationships
  members             WorkspaceMember[]
  channels            Channel[]
  phoneNumbers        PhoneNumber[]
  callerIds           CallerId[]
  calendarConnections CalendarConnection[]
  calendarEvents      CalendarEvent[]
  contacts            Contact[]
  conversations       Conversation[]
  agents              Agent[]
  voices              Voice[]
  knowledgeCollections KnowledgeCollection[]
  triggerRules        TriggerRule[]
  leads               Lead[]
  leadLists           LeadList[]
  campaigns           OutreachCampaign[]
  auditLogs           AuditLog[]
  usageEvents         UsageEvent[]
  tasks               Task[]
  messageTemplates    MessageTemplate[]

  // Billing
  subscription        WorkspaceSubscription?
  usageMonthly        WorkspaceUsageMonthly[]
  override            WorkspaceOverride?
  billingEvents       BillingEvent[]

  // Onboarding
  onboardingChecklist OnboardingChecklist?

  // Invitations
  invitations         WorkspaceInvitation[]

  @@index([slug])
}

model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique
  email         String   @unique
  firstName     String?
  lastName      String?
  avatarUrl     String?
  isSuperAdmin  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  memberships   WorkspaceMember[]
  auditLogs     AuditLog[]
  sentInvitations WorkspaceInvitation[]

  @@index([clerkId])
  @@index([email])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        MemberRole @default(MEMBER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

model WorkspaceInvitation {
  id          String            @id @default(cuid())
  workspaceId String
  email       String
  role        MemberRole        @default(MEMBER)
  status      InvitationStatus  @default(PENDING)
  token       String            @unique @default(cuid())
  expiresAt   DateTime
  invitedById String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  workspace   Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy   User?             @relation(fields: [invitedById], references: [id])

  @@unique([workspaceId, email])
  @@index([workspaceId])
  @@index([email])
  @@index([token])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================================================
// CHANNELS & PHONE NUMBERS
// ============================================================================

model Channel {
  id            String      @id @default(cuid())
  workspaceId   String
  type          ChannelType
  name          String
  externalId    String?     // Provider's channel ID
  config        Json        @default("{}")
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  workspace     Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([workspaceId, type, externalId])
  @@index([workspaceId])
}

enum ChannelType {
  WHATSAPP
  PHONE
}

model PhoneNumber {
  id            String   @id @default(cuid())
  workspaceId   String
  phoneNumber   String
  friendlyName  String?
  country       String?
  externalId    String?  // Provider's SID
  capabilities  Json     @default("{\"voice\":true,\"sms\":false}")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  callSessions  CallSession[]

  @@unique([externalId])
  @@index([workspaceId])
  @@index([phoneNumber])
}

model CallerId {
  id            String   @id @default(cuid())
  workspaceId   String
  phoneNumber   String
  friendlyName  String?
  isVerified    Boolean  @default(false)
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

// ============================================================================
// CALENDAR
// ============================================================================

model CalendarConnection {
  id              String           @id @default(cuid())
  workspaceId     String
  provider        CalendarProvider
  externalEmail   String
  accessToken     String           @db.Text
  refreshToken    String?          @db.Text
  tokenExpiresAt  DateTime?
  selectedCalendarId String?
  isDefault       Boolean          @default(false)
  workingHoursStart String         @default("09:00")
  workingHoursEnd   String         @default("18:00")
  workingDays     Int[]            @default([1, 2, 3, 4, 5])
  bufferMinutes   Int              @default(15)
  defaultDuration Int              @default(30)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  events          CalendarEvent[]

  @@unique([workspaceId, provider, externalEmail])
  @@index([workspaceId])
}

enum CalendarProvider {
  GOOGLE
  OUTLOOK
}

model CalendarEvent {
  id                    String              @id @default(cuid())
  workspaceId           String
  calendarConnectionId  String
  externalEventId       String?
  title                 String
  description           String?
  startTime             DateTime
  endTime               DateTime
  timezone              String
  location              String?
  attendeeEmail         String?
  attendeeName          String?
  attendeePhone         String?
  contactId             String?
  status                CalendarEventStatus @default(CONFIRMED)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  workspace             Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  calendarConnection    CalendarConnection  @relation(fields: [calendarConnectionId], references: [id], onDelete: Cascade)
  contact               Contact?            @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([calendarConnectionId])
  @@index([startTime, endTime])
}

enum CalendarEventStatus {
  CONFIRMED
  CANCELLED
  TENTATIVE
}

// ============================================================================
// CONTACTS & CRM
// ============================================================================

model Contact {
  id              String        @id @default(cuid())
  workspaceId     String
  externalId      String?
  phone           String?
  email           String?
  firstName       String?
  lastName        String?
  company         String?
  status          ContactStatus @default(PROSPECT)
  clientSince     DateTime?
  debtSince       DateTime?
  debtAmount      Decimal?      @db.Decimal(12, 2)
  lastContactAt   DateTime?
  nextActionAt    DateTime?
  nextActionNote  String?
  tags            String[]      @default([])
  metadata        Json          @default("{}")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  conversations   Conversation[]
  notes           ContactNote[]
  tasks           Task[]
  calendarEvents  CalendarEvent[]

  @@unique([workspaceId, phone])
  @@unique([workspaceId, email])
  @@index([workspaceId])
  @@index([status])
  @@index([phone])
  @@index([email])
}

enum ContactStatus {
  PROSPECT
  CLIENT
  LOST
}

model ContactNote {
  id          String   @id @default(cuid())
  contactId   String
  content     String   @db.Text
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
}

model Task {
  id            String     @id @default(cuid())
  workspaceId   String
  contactId     String?
  title         String
  description   String?
  dueAt         DateTime?
  completedAt   DateTime?
  status        TaskStatus @default(PENDING)
  priority      TaskPriority @default(MEDIUM)
  assignedTo    String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  workspace     Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contact       Contact?   @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([contactId])
  @@index([status])
  @@index([dueAt])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================================================
// CONVERSATIONS & MESSAGES
// ============================================================================

model Conversation {
  id              String           @id @default(cuid())
  workspaceId     String
  channelId       String
  contactId       String?
  externalId      String?          // Provider's conversation ID
  status          ConversationStatus @default(OPEN)
  assignedAgentId String?
  lastMessageAt   DateTime?
  unreadCount     Int              @default(0)
  metadata        Json             @default("{}")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  channel         Channel          @relation(fields: [channelId], references: [id], onDelete: Cascade)
  contact         Contact?         @relation(fields: [contactId], references: [id], onDelete: SetNull)
  agent           Agent?           @relation(fields: [assignedAgentId], references: [id], onDelete: SetNull)
  messages        Message[]
  callSessions    CallSession[]

  @@unique([channelId, externalId])
  @@index([workspaceId])
  @@index([contactId])
  @@index([status])
  @@index([lastMessageAt])
}

enum ConversationStatus {
  OPEN
  CLOSED
  ARCHIVED
}

model Message {
  id              String        @id @default(cuid())
  conversationId  String
  direction       MessageDirection
  content         String        @db.Text
  contentType     MessageContentType @default(TEXT)
  mediaUrl        String?
  externalId      String?
  status          MessageStatus @default(SENT)
  senderType      SenderType
  agentId         String?
  metadata        Json          @default("{}")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageContentType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
  LOCATION
  TEMPLATE
  SYSTEM
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum SenderType {
  USER
  CONTACT
  AGENT
  SYSTEM
}

// ============================================================================
// CALLS
// ============================================================================

model CallSession {
  id                String        @id @default(cuid())
  conversationId    String
  phoneNumberId     String?
  direction         CallDirection
  fromNumber        String
  toNumber          String
  externalCallId    String?
  status            CallStatus    @default(INITIATED)
  startedAt         DateTime?
  answeredAt        DateTime?
  endedAt           DateTime?
  durationSeconds   Int?
  recordingUrl      String?
  transcriptUrl     String?
  transcript        String?       @db.Text
  agentId           String?
  outcome           CallOutcome?
  metadata          Json          @default("{}")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  phoneNumber       PhoneNumber?  @relation(fields: [phoneNumberId], references: [id], onDelete: SetNull)
  recording         CallRecording?

  @@unique([externalCallId])
  @@index([conversationId])
  @@index([status])
  @@index([startedAt])
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
  CANCELLED
}

enum CallOutcome {
  ANSWERED
  VOICEMAIL
  NO_ANSWER
  BUSY
  FAILED
  SCHEDULED_MEETING
  SENT_INFO
  CALLBACK_REQUESTED
}

model CallRecording {
  id            String   @id @default(cuid())
  callSessionId String   @unique
  url           String
  durationSeconds Int?
  fileSize      Int?
  mimeType      String?
  createdAt     DateTime @default(now())

  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)
}

// ============================================================================
// AGENTS & VOICE
// ============================================================================

model Agent {
  id                  String    @id @default(cuid())
  workspaceId         String
  name                String
  template            AgentTemplate @default(SALES)
  description         String?
  systemPrompt        String?   @db.Text
  tone                String    @default("professional")
  language            String    @default("es-MX") // Agent response language
  voiceId             String?
  goals               String[]  @default([])
  enabledTools        String[]  @default([])
  knowledgeCollectionIds String[] @default([])
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  voice               Voice?    @relation(fields: [voiceId], references: [id], onDelete: SetNull)
  versions            AgentVersion[]
  conversations       Conversation[]

  @@index([workspaceId])
  @@index([isActive])
}

enum AgentTemplate {
  SALES
  SUPPORT
  COLLECTIONS
  CUSTOM
}

model AgentVersion {
  id            String   @id @default(cuid())
  agentId       String
  version       Int
  systemPrompt  String?  @db.Text
  config        Json
  createdAt     DateTime @default(now())

  agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, version])
  @@index([agentId])
}

model Voice {
  id              String   @id @default(cuid())
  workspaceId     String?  // null = system voice
  externalId      String?  // Provider's voice ID
  name            String
  language        String   @default("es-MX")
  tone            String?
  previewUrl      String?
  isCustom        Boolean  @default(false)
  isPublic        Boolean  @default(false)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace       Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  consent         VoiceConsent?
  agents          Agent[]

  @@index([workspaceId])
  @@index([isPublic])
}

model VoiceConsent {
  id            String   @id @default(cuid())
  voiceId       String   @unique
  consentGiven  Boolean
  consentText   String   @db.Text
  consentedAt   DateTime
  consentedBy   String   // user ID

  voice         Voice    @relation(fields: [voiceId], references: [id], onDelete: Cascade)
}

// ============================================================================
// KNOWLEDGE BASE
// ============================================================================

model KnowledgeCollection {
  id            String   @id @default(cuid())
  workspaceId   String
  name          String
  description   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sources       KnowledgeSource[]
  chunks        KnowledgeChunk[]

  @@index([workspaceId])
}

model KnowledgeSource {
  id              String             @id @default(cuid())
  collectionId    String
  type            KnowledgeSourceType
  name            String
  url             String?
  content         String?            @db.Text
  fileUrl         String?
  mimeType        String?
  status          KnowledgeSourceStatus @default(PENDING)
  errorMessage    String?
  metadata        Json               @default("{}")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  collection      KnowledgeCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  chunks          KnowledgeChunk[]

  @@index([collectionId])
  @@index([status])
}

enum KnowledgeSourceType {
  PDF
  URL
  FAQ
  TEXT
}

enum KnowledgeSourceStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

model KnowledgeChunk {
  id              String              @id @default(cuid())
  collectionId    String
  sourceId        String
  content         String              @db.Text
  embedding       Unsupported("vector(1536)")?
  tokenCount      Int?
  metadata        Json                @default("{}")
  createdAt       DateTime            @default(now())

  collection      KnowledgeCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  source          KnowledgeSource     @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([collectionId])
  @@index([sourceId])
}

// ============================================================================
// TRIGGERS & AUTOMATION
// ============================================================================

model TriggerRule {
  id            String          @id @default(cuid())
  workspaceId   String
  name          String
  description   String?
  triggerType   TriggerType
  conditions    Json
  actions       Json
  isActive      Boolean         @default(true)
  priority      Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([triggerType])
  @@index([isActive])
}

enum TriggerType {
  KEYWORD
  CALL_OUTCOME
  NO_REPLY
  OVERDUE_TASK
  NEW_CONTACT
  SCHEDULE_EVENT
}

// ============================================================================
// LEADS & CAMPAIGNS
// ============================================================================

model Lead {
  id            String      @id @default(cuid())
  workspaceId   String
  source        LeadSource
  externalId    String?
  firstName     String?
  lastName      String?
  email         String?
  phone         String?
  company       String?
  title         String?
  industry      String?
  location      String?
  linkedinUrl   String?
  website       String?
  metadata      Json        @default("{}")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  workspace     Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  listMemberships LeadListMember[]

  @@index([workspaceId])
  @@index([email])
  @@index([phone])
}

enum LeadSource {
  B2B_SEARCH
  MAPS_SEARCH
  IMPORT
  MANUAL
}

model LeadList {
  id            String   @id @default(cuid())
  workspaceId   String
  name          String
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members       LeadListMember[]
  campaigns     OutreachCampaign[]

  @@index([workspaceId])
}

model LeadListMember {
  id          String   @id @default(cuid())
  leadListId  String
  leadId      String
  addedAt     DateTime @default(now())

  leadList    LeadList @relation(fields: [leadListId], references: [id], onDelete: Cascade)
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([leadListId, leadId])
  @@index([leadListId])
  @@index([leadId])
}

model OutreachCampaign {
  id              String          @id @default(cuid())
  workspaceId     String
  name            String
  description     String?
  type            CampaignType
  leadListId      String?
  agentId         String?
  callerIdId      String?
  templateId      String?
  scheduledStart  DateTime?
  scheduledEnd    DateTime?
  callingWindowStart String?
  callingWindowEnd   String?
  callingWindowTz    String?
  pacePerHour     Int             @default(30)
  fallbackToWhatsApp Boolean      @default(false)
  status          CampaignStatus  @default(DRAFT)
  stats           Json            @default("{}")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  leadList        LeadList?       @relation(fields: [leadListId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([status])
}

enum CampaignType {
  WHATSAPP
  PHONE
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

// ============================================================================
// MESSAGE TEMPLATES
// ============================================================================

model MessageTemplate {
  id            String   @id @default(cuid())
  workspaceId   String
  name          String
  category      String
  content       String   @db.Text
  variables     String[] @default([])
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([category])
}

// ============================================================================
// ONBOARDING
// ============================================================================

model OnboardingChecklist {
  id                  String   @id @default(cuid())
  workspaceId         String   @unique
  whatsappConnected   Boolean  @default(false)
  phoneConnected      Boolean  @default(false)
  calendarConnected   Boolean  @default(false)
  agentCreated        Boolean  @default(false)
  voiceSelected       Boolean  @default(false)
  knowledgeAdded      Boolean  @default(false)
  liveModeEnabled     Boolean  @default(false)
  billingConfigured   Boolean  @default(false)
  completedAt         DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

// ============================================================================
// AUDIT & USAGE
// ============================================================================

model AuditLog {
  id            String   @id @default(cuid())
  workspaceId   String
  userId        String?
  action        String
  resource      String
  resourceId    String?
  changes       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model UsageEvent {
  id            String       @id @default(cuid())
  workspaceId   String
  type          UsageEventType
  quantity      Decimal      @db.Decimal(10, 4)
  unit          String
  resourceId    String?
  metadata      Json         @default("{}")
  createdAt     DateTime     @default(now())

  workspace     Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([type])
  @@index([createdAt])
}

enum UsageEventType {
  CALL_MINUTE
  WHATSAPP_CONVERSATION
  VOICE_CLONE
  AI_TOKEN
  STORAGE_MB
}

// ============================================================================
// BILLING
// ============================================================================

model Region {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  planRegions PlanRegion[]
  countryMaps CountryRegionMap[]
  costAssumptions RegionCostAssumption?
}

model CountryRegionMap {
  id          String   @id @default(cuid())
  countryCode String   @unique // ISO2
  regionCode  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  region      Region   @relation(fields: [regionCode], references: [code], onDelete: Cascade)

  @@index([regionCode])
}

model Plan {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  isPublic    Boolean  @default(true)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  planRegions PlanRegion[]
}

model PlanRegion {
  id                              String   @id @default(cuid())
  planId                          String
  regionCode                      String
  currency                        String   @default("USD")
  displayPriceMonthly             Decimal  @db.Decimal(10, 2)
  stripePriceId                   String?
  includedCallMinutes             Int
  includedWhatsappConversations   Int
  includedSeats                   Int?
  includedAgents                  Int?
  includedPhoneNumbers            Int?
  overageCallMinutePrice          Decimal  @db.Decimal(10, 4)
  overageWhatsappConversationPrice Decimal @db.Decimal(10, 4)
  limitMode                       LimitMode @default(SOFT)
  isActive                        Boolean  @default(true)
  version                         Int      @default(1)
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt

  plan                            Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  region                          Region   @relation(fields: [regionCode], references: [code], onDelete: Cascade)

  @@unique([planId, regionCode])
  @@index([planId])
  @@index([regionCode])
}

enum LimitMode {
  SOFT
  HARD
}

model WorkspaceSubscription {
  id                  String             @id @default(cuid())
  workspaceId         String             @unique
  planCode            String
  regionCode          String
  stripeCustomerId    String?
  stripeSubscriptionId String?
  stripePriceId       String?
  status              SubscriptionStatus @default(INACTIVE)
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  workspace           Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
}

model WorkspaceUsageMonthly {
  id                        String   @id @default(cuid())
  workspaceId               String
  periodStart               DateTime
  periodEnd                 DateTime
  callMinutesUsed           Decimal  @db.Decimal(10, 2) @default(0)
  whatsappConversationsUsed Int      @default(0)
  seatsUsed                 Int      @default(0)
  agentsUsed                Int      @default(0)
  phoneNumbersUsed          Int      @default(0)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  workspace                 Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, periodStart])
  @@index([workspaceId])
  @@index([periodStart])
}

model WorkspaceOverride {
  id                                String   @id @default(cuid())
  workspaceId                       String   @unique
  customIncludedCallMinutes         Int?
  customIncludedWhatsappConversations Int?
  customOverageCallMinutePrice      Decimal? @db.Decimal(10, 4)
  customOverageWhatsappConversationPrice Decimal? @db.Decimal(10, 4)
  customLimitMode                   LimitMode?
  notes                             String?  @db.Text
  isActive                          Boolean  @default(true)
  createdAt                         DateTime @default(now())
  updatedAt                         DateTime @updatedAt

  workspace                         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model BillingEvent {
  id            String           @id @default(cuid())
  workspaceId   String
  type          BillingEventType
  payloadJson   Json
  createdAt     DateTime         @default(now())

  workspace     Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([type])
  @@index([createdAt])
}

enum BillingEventType {
  STRIPE_WEBHOOK
  PLAN_CHANGE
  QUOTA_RESET
  OVERAGE_INVOICED
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELLED
}

model RegionCostAssumption {
  id                          String   @id @default(cuid())
  regionCode                  String   @unique
  callCostPerMinute           Decimal  @db.Decimal(10, 4)
  whatsappCostPerConversation Decimal  @db.Decimal(10, 4)
  aiCostPerUnit               Decimal? @db.Decimal(10, 6)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  region                      Region   @relation(fields: [regionCode], references: [code], onDelete: Cascade)
}
